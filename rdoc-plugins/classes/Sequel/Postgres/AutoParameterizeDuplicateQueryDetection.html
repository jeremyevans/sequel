<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Sequel::Postgres::AutoParameterizeDuplicateQueryDetection</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Sequel::Postgres::AutoParameterizeDuplicateQueryDetection
</h1>
<ol class='paths'>
<li>
<a href="../../../files/lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection_rb.html">lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>Enable detecting duplicate queries inside a block</p>
</div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-extended">extended</a></li>
</ol>
<h3>Public Instance</h3>
<ol>
<li><a href="#method-i-detect_duplicate_queries">detect_duplicate_queries</a></li>
<li><a href="#method-i-execute">execute</a></li>
<li><a href="#method-i-ignore_duplicate_queries">ignore_duplicate_queries</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="AutoParameterizeDuplicateQueryDetection/DuplicateQueries.html">Sequel::Postgres::AutoParameterizeDuplicateQueryDetection::DuplicateQueries</a></li>
</ol>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-extended'>
<a name='method-c-extended'></a>
<div class='synopsis'>
<span class='name'>extended</span><span class='arguments'>(db)</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-extended-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-extended-source'>   <span class="ruby-comment"># File lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection.rb</span>
<span class="line-num">62</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">extended</span>(<span class="ruby-identifier">db</span>)
<span class="line-num">63</span>   <span class="ruby-identifier">db</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num">64</span>     <span class="ruby-ivar">@duplicate_query_detection_contexts</span> = {}
<span class="line-num">65</span>     <span class="ruby-ivar">@duplicate_query_detection_mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
<span class="line-num">66</span>   <span class="ruby-keyword">end</span>
<span class="line-num">67</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<h2>Public Instance methods</h2>
<div class='method public-instance' id='method-method-i-detect_duplicate_queries'>
<a name='method-i-detect_duplicate_queries'></a>
<div class='synopsis'>
<span class='name'>detect_duplicate_queries</span><span class='arguments'>(opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Run the duplicate query detector during the block. Options:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>:backtrace_filter </td><td>
<p>Regexp used to filter the displayed backtrace.</p>
</td></tr><tr><td class='label'>:handler </td><td>
<p>If present, called with hash of duplicate query information, instead of raising or warning.</p>
</td></tr><tr><td class='label'>:warn </td><td>
<p>Always warn instead of raising for duplicate queries.</p>
</td></tr></tbody></table>

<p>Note that if you nest calls to this method, only the top level call will respect the passed options.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-detect_duplicate_queries-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-detect_duplicate_queries-source'>    <span class="ruby-comment"># File lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection.rb</span>
<span class="line-num">122</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">detect_duplicate_queries</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">123</span>   <span class="ruby-identifier">current</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">current</span>
<span class="line-num">124</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">state</span> = <span class="ruby-identifier">duplicate_query_recorder_state</span>(<span class="ruby-identifier">current</span>)
<span class="line-num">125</span>     <span class="ruby-keyword">return</span> <span class="ruby-identifier">change_duplicate_query_recorder_state</span>(<span class="ruby-identifier">state</span>, <span class="ruby-keyword">true</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">126</span>   <span class="ruby-keyword">end</span>
<span class="line-num">127</span> 
<span class="line-num">128</span>   <span class="ruby-ivar">@duplicate_query_detection_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
<span class="line-num">129</span>     <span class="ruby-ivar">@duplicate_query_detection_contexts</span>[<span class="ruby-identifier">current</span>] = [<span class="ruby-keyword">true</span>, <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">0</span>)]
<span class="line-num">130</span>   <span class="ruby-keyword">end</span>
<span class="line-num">131</span> 
<span class="line-num">132</span>   <span class="ruby-keyword">begin</span>
<span class="line-num">133</span>     <span class="ruby-keyword">yield</span>
<span class="line-num">134</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">135</span>     <span class="ruby-identifier">raise</span>
<span class="line-num">136</span>   <span class="ruby-keyword">ensure</span>
<span class="line-num">137</span>     <span class="ruby-identifier">_</span>, <span class="ruby-identifier">queries</span> = <span class="ruby-ivar">@duplicate_query_detection_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
<span class="line-num">138</span>       <span class="ruby-ivar">@duplicate_query_detection_contexts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">current</span>)
<span class="line-num">139</span>     <span class="ruby-keyword">end</span>
<span class="line-num">140</span>     <span class="ruby-identifier">queries</span>.<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">_</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>}
<span class="line-num">141</span> 
<span class="line-num">142</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">queries</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">143</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">handler</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:handler</span>]
<span class="line-num">144</span>         <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">queries</span>)
<span class="line-num">145</span>       <span class="ruby-keyword">else</span>
<span class="line-num">146</span>         <span class="ruby-identifier">backtrace_filter</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:backtrace_filter</span>]
<span class="line-num">147</span>         <span class="ruby-identifier">backtrace_filter_note</span> = <span class="ruby-identifier">backtrace_filter</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot; (filtered)&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;&quot;</span>
<span class="line-num">148</span>         <span class="ruby-identifier">query_info</span> = <span class="ruby-identifier">queries</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">149</span>           <span class="ruby-identifier">backtrace</span> = <span class="ruby-identifier">k</span>[<span class="ruby-value">1</span>]
<span class="line-num">150</span>           <span class="ruby-identifier">backtrace</span> = <span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-identifier">backtrace_filter</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">backtrace_filter</span>
<span class="line-num">151</span>           <span class="ruby-node">&quot;times:#{v}\nsql:#{k[0]}\nbacktrace#{backtrace_filter_note}:\n#{backtrace.join(&quot;\n&quot;)}\n&quot;</span>
<span class="line-num">152</span>         <span class="ruby-keyword">end</span>
<span class="line-num">153</span>         <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;duplicate queries detected:\n\n#{query_info.join(&quot;\n&quot;)}&quot;</span>
<span class="line-num">154</span> 
<span class="line-num">155</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:warn</span>]
<span class="line-num">156</span>           <span class="ruby-identifier">warn</span>(<span class="ruby-identifier">message</span>)
<span class="line-num">157</span>         <span class="ruby-keyword">else</span>
<span class="line-num">158</span>           <span class="ruby-identifier">raise</span> <span class="ruby-constant">DuplicateQueries</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">queries</span>)
<span class="line-num">159</span>         <span class="ruby-keyword">end</span>
<span class="line-num">160</span>       <span class="ruby-keyword">end</span>
<span class="line-num">161</span>     <span class="ruby-keyword">end</span>
<span class="line-num">162</span>   <span class="ruby-keyword">end</span>
<span class="line-num">163</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-execute'>
<a name='method-i-execute'></a>
<div class='synopsis'>
<span class='name'>execute</span><span class='arguments'>(sql, opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Record each query executed so duplicates can be detected, if queries are being recorded.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-execute-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-execute-source'>   <span class="ruby-comment"># File lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection.rb</span>
<span class="line-num">85</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">86</span>   <span class="ruby-identifier">record</span>, <span class="ruby-identifier">queries</span> = <span class="ruby-identifier">duplicate_query_recorder_state</span>
<span class="line-num">87</span> 
<span class="line-num">88</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">record</span>
<span class="line-num">89</span>     <span class="ruby-identifier">queries</span>[[<span class="ruby-identifier">sql</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">sql</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">sql</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">caller</span>].<span class="ruby-identifier">freeze</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="line-num">90</span>   <span class="ruby-keyword">end</span>
<span class="line-num">91</span> 
<span class="line-num">92</span>   <span class="ruby-keyword">super</span>
<span class="line-num">93</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-ignore_duplicate_queries'>
<a name='method-i-ignore_duplicate_queries'></a>
<div class='synopsis'>
<span class='name'>ignore_duplicate_queries</span><span class='arguments'>(&block)</span>

</div>
<div class='description'>

<p>Ignore (do not record) queries inside given block. This can be useful in situations where you want to run your entire test suite with duplicate query detection, but you have duplicate queries in some parts of your application where it is not trivial to use a different approach. You can mark those specific sections with <a href="AutoParameterizeDuplicateQueryDetection.html#method-i-ignore_duplicate_queries"><code>ignore_duplicate_queries</code></a>, and still get duplicate query detection for the rest of the application.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-ignore_duplicate_queries-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-ignore_duplicate_queries-source'>    <span class="ruby-comment"># File lib/sequel/extensions/pg_auto_parameterize_duplicate_query_detection.rb</span>
<span class="line-num">102</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ignore_duplicate_queries</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">103</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">state</span> = <span class="ruby-identifier">duplicate_query_recorder_state</span>
<span class="line-num">104</span>     <span class="ruby-identifier">change_duplicate_query_recorder_state</span>(<span class="ruby-identifier">state</span>, <span class="ruby-keyword">false</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">105</span>   <span class="ruby-keyword">else</span>
<span class="line-num">106</span>     <span class="ruby-comment"># If we are not inside a detect_duplicate_queries block, there is</span>
<span class="line-num">107</span>     <span class="ruby-comment"># no need to do anything, since we are not recording queries.</span>
<span class="line-num">108</span>     <span class="ruby-keyword">yield</span>
<span class="line-num">109</span>   <span class="ruby-keyword">end</span>
<span class="line-num">110</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
