<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Sequel::Plugins::PgAutoConstraintValidations</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Sequel::Plugins::PgAutoConstraintValidations
</h1>
<ol class='paths'>
<li>
<a href="../../../files/lib/sequel/plugins/pg_auto_constraint_validations_rb.html">lib/sequel/plugins/pg_auto_constraint_validations.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>The pg_auto_constraint_validations plugin automatically converts some constraint violation exceptions that are raised by INSERT/UPDATE queries into validation failures.  This can allow for using the same error handling code for both regular validation errors (checked before attempting the INSERT/UPDATE), and constraint violations (raised during the INSERT/UPDATE).</p>

<p>This handles the following constraint violations:</p>
<ul><li>
<p>NOT NULL</p>
</li><li>
<p>CHECK</p>
</li><li>
<p>UNIQUE (except expression/functional indexes)</p>
</li><li>
<p>FOREIGN KEY (both referencing and referenced by)</p>
</li></ul>

<p>If the plugin cannot convert the constraint violation error to a validation error, it just reraises the initial exception, so this should not cause problems if the plugin doesn&#39;t know how to convert the exception.</p>

<p>This plugin is not intended as a replacement for other validations, it is intended as a last resort.  The purpose of validations is to provide nice error messages for the user, and the error messages generated by this plugin are fairly generic by default.  The error messages can be customized per constraint type using the :messages plugin option, and individually per constraint using <code>pg_auto_constraint_validation_override</code> (see below).</p>

<p>This plugin only works on the postgres adapter when using the pg 0.16+ driver, PostgreSQL 9.3+ server, and PostgreSQL 9.3+ client library (libpq). In other cases it will be a no-op.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">album</span> = <span class="ruby-constant">Album</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:artist_id</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>) <span class="ruby-comment"># Assume no such artist exists</span>&#x000A;<span class="ruby-keyword">begin</span>&#x000A;  <span class="ruby-identifier">album</span>.<span class="ruby-identifier">save</span>&#x000A;<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">ValidationFailed</span>&#x000A;  <span class="ruby-identifier">album</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value">:artist_id</span>) <span class="ruby-comment"># [&#39;is invalid&#39;]</span>&#x000A;<span class="ruby-keyword">end</span></pre>

<p>While the database usually provides enough information to correctly associated constraint violations with model columns, there are cases where it does not. In those cases, you can override the handling of specific constraint violations to be associated to particular column(s), and use a specific error message:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">pg_auto_constraint_validation_override</span>(<span class="ruby-value">:constraint_name</span>, [<span class="ruby-value">:column1</span>], <span class="ruby-string">&quot;validation error message&quot;</span>)</pre>

<p>Using the pg_auto_constraint_validations plugin requires 5 queries per model at load time in order to gather the necessary metadata.  For applications with a large number of models, this can result in a noticeable delay during model initialization.  To mitigate this issue, you can cache the necessary metadata in a file with the :cache_file option:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span>, <span class="ruby-value">cache_file:</span> <span class="ruby-string">&#39;db/pgacv.cache&#39;</span></pre>

<p>The file does not have to exist when loading the plugin.  If it exists, the plugin will load the cache and use the cached results instead of issuing queries if there is an entry in the cache.  If there is no entry in the cache, it will update the in-memory cache with the metadata results.  To save the in in-memory cache back to the cache file, run:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">dump_pg_auto_constraint_validations_cache</span></pre>

<p>Note that when using the :cache_file option, it is up to the application to ensure that the dumped cached metadata reflects the current state of the database.  <a href="../../Sequel.html"><code>Sequel</code></a> does no checking to ensure this, as checking would take time and the purpose of this code is to take a shortcut.</p>

<p>The cached schema is dumped in Marshal format, since it is the fastest and it handles all ruby objects used in the metadata.  Because of this, you should not attempt to load the metadata from a untrusted file.</p>

<p>Usage:</p>

<pre class="ruby"><span class="ruby-comment"># Make all model subclasses automatically convert constraint violations</span>&#x000A;<span class="ruby-comment"># to validation failures (called before loading subclasses)</span>&#x000A;<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span>&#x000A;&#x000A;<span class="ruby-comment"># Make the Album class automatically convert constraint violations</span>&#x000A;<span class="ruby-comment"># to validation failures</span>&#x000A;<span class="ruby-constant">Album</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span></pre>
</div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-configure">configure</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="PgAutoConstraintValidations/ClassMethods.html">Sequel::Plugins::PgAutoConstraintValidations::ClassMethods</a></li>
<li><a href="PgAutoConstraintValidations/InstanceMethods.html">Sequel::Plugins::PgAutoConstraintValidations::InstanceMethods</a></li>
</ol>
</div>
<div id='section'>
<div id='constants-list'>
<h2>Constants</h2>
<div class='name-list'>
<table summary='Constants'>
<tr class='top-aligned-row context-row'>
<td class='context-item-name'>DEFAULT_ERROR_MESSAGES</td>
<td>=</td>
<td class='context-item-value'>{
:not_null=>"is not present",
:check=>"is invalid",
:unique=>'is already taken',
:foreign_key=>'is invalid',
:referenced_by=>'cannot be changed currently'
}.freeze).each_value(&:freeze)</td>
<td>&nbsp;</td>
<td class='context-item-desc'>
<p>The default error messages for each constraint violation type.</p>
</td>
</tr>
</table>
</div>
</div>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-configure'>
<a name='method-c-configure'></a>
<div class='synopsis'>
<span class='name'>configure</span>
<span class='arguments'>(model, opts=OPTS)</span>

</div>
<div class='description'>

<p>Setup the constraint violation metadata.  Options:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>:cache_file </td><td>
<p>File storing cached metadata, to avoid queries for each model</p>
</td></tr><tr><td class='label'>:messages </td><td>
<p>Override the default error messages for each constraint violation type (:not_null, :check, :unique, :foreign_key, :referenced_by)</p>
</td></tr></tbody></table>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-configure-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-configure-source'>    <span class="ruby-comment"># File lib/sequel/plugins/pg_auto_constraint_validations.rb</span>&#x000A;<span class="line-num"> 98</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">configure</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)&#x000A;<span class="line-num"> 99</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>&#x000A;<span class="line-num">100</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:cache_file</span>]&#x000A;<span class="line-num">101</span>       <span class="ruby-ivar">@pg_auto_constraint_validations_cache</span> = <span class="ruby-keyword">if</span> <span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">file?</span>(<span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span>)&#x000A;<span class="line-num">102</span>         <span class="ruby-identifier">cache</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span>))&#x000A;<span class="line-num">103</span>         <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span><span class="ruby-operator">|</span>&#x000A;<span class="line-num">104</span>           <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">freeze</span>.<span class="ruby-identifier">each_value</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:freeze</span>)&#x000A;<span class="line-num">105</span>         <span class="ruby-keyword">end</span>&#x000A;<span class="line-num">106</span>       <span class="ruby-keyword">else</span>&#x000A;<span class="line-num">107</span>         {}&#x000A;<span class="line-num">108</span>       <span class="ruby-keyword">end</span>&#x000A;<span class="line-num">109</span>     <span class="ruby-keyword">else</span>&#x000A;<span class="line-num">110</span>       <span class="ruby-ivar">@pg_auto_constraint_validations_cache</span> = <span class="ruby-keyword">nil</span>&#x000A;<span class="line-num">111</span>     <span class="ruby-keyword">end</span>&#x000A;<span class="line-num">112</span> &#x000A;<span class="line-num">113</span>     <span class="ruby-identifier">setup_pg_auto_constraint_validations</span>&#x000A;<span class="line-num">114</span>     <span class="ruby-ivar">@pg_auto_constraint_validations_messages</span> = (<span class="ruby-ivar">@pg_auto_constraint_validations_messages</span> <span class="ruby-operator">||</span> <span class="ruby-constant">DEFAULT_ERROR_MESSAGES</span>).<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:messages</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">OPTS</span>).<span class="ruby-identifier">freeze</span>&#x000A;<span class="line-num">115</span>   <span class="ruby-keyword">end</span>&#x000A;<span class="line-num">116</span>   <span class="ruby-keyword">nil</span>&#x000A;<span class="line-num">117</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/rdoc/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
