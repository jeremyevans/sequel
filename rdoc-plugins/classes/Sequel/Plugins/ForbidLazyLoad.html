<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Sequel::Plugins::ForbidLazyLoad</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Sequel::Plugins::ForbidLazyLoad
</h1>
<ol class='paths'>
<li>
<a href="../../../files/lib/sequel/plugins/forbid_lazy_load_rb.html">lib/sequel/plugins/forbid_lazy_load.rb</a>
</li>
<li class='other'>
<a href="../../../files/lib/sequel/plugins/static_cache_rb.html">lib/sequel/plugins/static_cache.rb</a>
</li>
<li>
<a class='show' href='#' onclick='this.parentNode.parentNode.className += &quot; expanded&quot;; this.parentNode.removeChild(this); return false'>show all</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>The <a href="../../../files/lib/sequel/plugins/forbid_lazy_load_rb.html">forbid_lazy_load</a> plugin forbids lazy loading of associations for objects in cases where the object wasn’t loaded with a method that only returns a single object.</p>

<p>The main reason for doing this is it makes it easier to detect N+1 query issues. Note that <a href="../../Sequel.html"><code>Sequel</code></a> also offers a <a href="../../../files/lib/sequel/plugins/tactical_eager_loading_rb.html">tactical_eager_loading</a> plugin which will automatically eagerly load associations for all objects retrived in the same query if any object would attempt to lazily load an association. That approach may be simpler if you are trying to prevent N+1 issues, though it does retain more objects in memory.</p>

<p>This plugin offers multiple different ways to forbid lazy loading.  You can forbid lazy loading associations for individual model instances:</p>

<pre class="ruby"><span class="ruby-identifier">obj</span> = <span class="ruby-constant">Album</span>[<span class="ruby-value">1</span>]
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">forbid_lazy_load</span>
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># raises Sequel::Plugins::ForbidLazyLoad::Error</span>
</pre>

<p><a href="../../../files/lib/sequel/plugins/forbid_lazy_load_rb.html">forbid_lazy_load</a> is automatically called on instances if the instances are loaded via a method such as Dataset#all, Dataset#each, and other methods that load multiple instances at once.  These are the cases where lazily loading associations for such instances can cause N+1 issues.</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">artist</span>
<span class="ruby-identifier">objs</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># raises Sequel::Plugins::ForbidLazyLoad::Error</span>

<span class="ruby-constant">Album</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># raises Sequel::Plugins::ForbidLazyLoad::Error</span>
<span class="ruby-keyword">end</span>

<span class="ruby-constant">Album</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">artist</span> <span class="ruby-comment"># no error</span>

<span class="ruby-constant">Album</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># no error</span>
</pre>

<p>This behavior of enabling <a href="../../../files/lib/sequel/plugins/forbid_lazy_load_rb.html">forbid_lazy_load</a> automatically from dataset methods can be disabled using the plugin’s <code>:allow_by_default</code> option.</p>

<p>You can allow lazy loading associations for an instance that it was previously forbidden for:</p>

<pre class="ruby"><span class="ruby-identifier">obj</span> = <span class="ruby-constant">Album</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">allow_lazy_load</span>
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># no error</span>
</pre>

<p>You can forbid lazy loading associations on a per-call basis, even if lazy loading of associations is allowed for the instance:</p>

<pre class="ruby"><span class="ruby-identifier">obj</span> = <span class="ruby-constant">Album</span>[<span class="ruby-value">1</span>]
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist</span>(<span class="ruby-value">forbid_lazy_load:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-comment"># raises Sequel::Plugins::ForbidLazyLoad::Error</span>
</pre>

<p>This also works for allowing lazy loading associations for a specific association load even if it is forbidden for the instance:</p>

<pre class="ruby"><span class="ruby-identifier">obj</span> = <span class="ruby-constant">Album</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist</span>(<span class="ruby-value">forbid_lazy_load:</span> <span class="ruby-keyword">false</span>)
<span class="ruby-comment"># nothing raised</span>
</pre>

<p>You can also forbid lazy loading on a per-association basis using the <code>:forbid_lazy_load</code> association option with a <code>true</code> value:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">forbid_lazy_load:</span> <span class="ruby-keyword">true</span>
<span class="ruby-constant">Album</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">artist</span> <span class="ruby-comment"># raises Sequel::Plugins::ForbidLazyLoad::Error</span>
</pre>

<p>However, you probably don’t want to do this as it will forbid any lazy loading of the association, even if the loading could not result in an N+1 issue.</p>

<p>On the flip side, you can allow lazy loading using the <code>:forbid_lazy_load</code> association option with a <code>false</code> value:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">forbid_lazy_load:</span> <span class="ruby-keyword">false</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># no error</span>
</pre>

<p>One reason to do this is when using a plugin like <a href="../../../files/lib/sequel/plugins/static_cache_rb.html">static_cache</a> on the associated model, where a query is not actually issued when doing a lazy association load.  To make that particular case easier, this plugin makes Model.finalize_associations automatically set the association option if the associated class uses the <a href="../../../files/lib/sequel/plugins/static_cache_rb.html">static_cache</a> plugin.</p>

<p>Note that even with this plugin, there can still be N+1 issues, such as:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span> <span class="ruby-comment"># 1 query for all albums</span>
  <span class="ruby-constant">Artist</span>[<span class="ruby-identifier">obj</span>.<span class="ruby-identifier">artist_id</span>] <span class="ruby-comment"># 1 query per album for each artist</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Usage:</p>

<pre class="ruby"><span class="ruby-comment"># Make all model subclasses support forbidding lazy load</span>
<span class="ruby-comment"># (called before loading subclasses)</span>
<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:forbid_lazy_load</span>

<span class="ruby-comment"># Make the Album class support forbidding lazy load</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:forbid_lazy_load</span>

<span class="ruby-comment"># Let lazy loading be forbidden by object, but not automatically for any</span>
<span class="ruby-comment"># object loaded via dataset.</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:forbid_lazy_load</span>, <span class="ruby-value">allow_by_default:</span> <span class="ruby-keyword">true</span>
</pre>
</div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-apply">apply</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="ForbidLazyLoad/ClassMethods.html">Sequel::Plugins::ForbidLazyLoad::ClassMethods</a></li>
<li><a href="ForbidLazyLoad/ForbidByDefault.html">Sequel::Plugins::ForbidLazyLoad::ForbidByDefault</a></li>
<li><a href="ForbidLazyLoad/InstanceMethods.html">Sequel::Plugins::ForbidLazyLoad::InstanceMethods</a></li>
<li><a href="ForbidLazyLoad/Error.html">Sequel::Plugins::ForbidLazyLoad::Error</a></li>
</ol>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-apply'>
<a name='method-c-apply'></a>
<div class='synopsis'>
<span class='name'>apply</span><span class='arguments'>(model, opts=OPTS)</span>

</div>
<div class='description'>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-apply-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-apply-source'>    <span class="ruby-comment"># File lib/sequel/plugins/forbid_lazy_load.rb</span>
<span class="line-num">109</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">apply</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">110</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:allow_by_default</span>]
<span class="line-num">111</span>     <span class="ruby-identifier">model</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:dataset_extend</span>, <span class="ruby-constant">ForbidByDefault</span>, <span class="ruby-value">:create_class_methods</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>)
<span class="line-num">112</span>   <span class="ruby-keyword">end</span>
<span class="line-num">113</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
